<!DOCTYPE html>
<html lang="mn">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0"/>
<title>–•“Ø—Ä–≥—ç–ª—Ç - –ù—ç–≤—Ç—Ä—ç—Ö</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:linear-gradient(135deg,#1a2f6b 0%,#2d4b9e 50%,#3d5cb5 100%);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
.card{background:#fff;border-radius:24px;padding:36px 32px;width:100%;max-width:380px;box-shadow:0 24px 64px rgba(0,0,0,.3)}
.logo{text-align:center;margin-bottom:28px}
.logo-icon{font-size:52px;display:block;margin-bottom:10px}
.logo-title{font-size:26px;font-weight:800;color:#1a2332}
.logo-sub{font-size:13px;color:#8a96a8;margin-top:4px}
label{font-size:13px;font-weight:700;color:#2d3a4a;display:block;margin-bottom:8px}
.inp{width:100%;padding:14px 18px;border:2px solid #e2e8f0;border-radius:12px;font-size:22px;text-align:center;letter-spacing:4px;font-family:inherit;color:#1a2332;outline:none;transition:border-color .2s}
.inp:focus{border-color:#2d4b9e}
.inp.error{border-color:#b91c1c;animation:shake .3s}
@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-8px)}75%{transform:translateX(8px)}}
.btn{width:100%;padding:15px;border-radius:12px;border:none;background:linear-gradient(135deg,#2d4b9e,#3d5cb5);color:#fff;font-size:16px;font-weight:700;cursor:pointer;font-family:inherit;margin-top:14px;box-shadow:0 6px 20px rgba(91,33,182,.35);transition:opacity .2s}
.btn:hover{opacity:.9}
.btn:disabled{opacity:.6;cursor:not-allowed}
.err{display:none;margin-top:12px;padding:12px 14px;border-radius:10px;background:#fee2e2;color:#b91c1c;font-size:13px;font-weight:600;text-align:center}
.footer{text-align:center;margin-top:20px;font-size:12px;color:#94a3b8}
.dot{width:18px;height:18px;border-radius:50%;background:#e2e8f0;transition:all 0.15s}
.dot.filled{background:#2d4b9e;transform:scale(1.1)}
.dot.error{background:#ef4444}
.numpad{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.np{padding:18px;border-radius:14px;border:1.5px solid #e2e8f0;background:#fff;font-size:22px;font-weight:700;color:#1a2332;cursor:pointer;font-family:inherit;transition:all .15s}
.np:active{background:#ede9fe;border-color:#2d4b9e}
</style>
</head>
<body>
<div class="card">
  <div class="logo">
    <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA4MCA4MCIgd2lkdGg9IjYwIiBoZWlnaHQ9IjYwIj4KICA8IS0tIEJveCAtLT4KICA8cmVjdCB4PSIxMiIgeT0iOCIgd2lkdGg9IjQ0IiBoZWlnaHQ9IjQyIiBmaWxsPSJub25lIiBzdHJva2U9IiMyZDRiOWUiIHN0cm9rZS13aWR0aD0iNSIvPgogIDwhLS0gQm94IHRvcCBub3RjaCAtLT4KICA8cG9seWxpbmUgcG9pbnRzPSIzMCw4IDMwLDIwIDM4LDIwIDM4LDgiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzJkNGI5ZSIgc3Ryb2tlLXdpZHRoPSI1Ii8+CiAgPCEtLSBCb3ggbGFiZWwgLS0+CiAgPHJlY3QgeD0iMTYiIHk9IjM0IiB3aWR0aD0iMTQiIGhlaWdodD0iMTAiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzJkNGI5ZSIgc3Ryb2tlLXdpZHRoPSI0Ii8+CiAgPCEtLSBQYWxsZXQgYmFzZSAtLT4KICA8cmVjdCB4PSI2IiB5PSI1MiIgd2lkdGg9IjU2IiBoZWlnaHQ9IjgiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzJkNGI5ZSIgc3Ryb2tlLXdpZHRoPSI1Ii8+CiAgPCEtLSBQYWxsZXQgbGVncyAtLT4KICA8cmVjdCB4PSI3IiB5PSI2MCIgd2lkdGg9IjEwIiBoZWlnaHQ9IjEwIiBmaWxsPSJub25lIiBzdHJva2U9IiMyZDRiOWUiIHN0cm9rZS13aWR0aD0iNCIvPgogIDxyZWN0IHg9IjI5IiB5PSI2MCIgd2lkdGg9IjEwIiBoZWlnaHQ9IjEwIiBmaWxsPSJub25lIiBzdHJva2U9IiMyZDRiOWUiIHN0cm9rZS13aWR0aD0iNCIvPgogIDxyZWN0IHg9IjUxIiB5PSI2MCIgd2lkdGg9IjEwIiBoZWlnaHQ9IjEwIiBmaWxsPSJub25lIiBzdHJva2U9IiMyZDRiOWUiIHN0cm9rZS13aWR0aD0iNCIvPgo8L3N2Zz4=" width="60" height="60" style="display:block;margin:0 auto 8px">
    <div class="logo-title" style="font-size:28px;font-weight:800;color:#2d4b9e;letter-spacing:2px">MESO</div>
    
  </div>

  <!-- –ê–ª—Ö–∞–º 1: –£—Ç–∞—Å -->
  <div id="step-phone">
    <label>–£—Ç–∞—Å–Ω—ã –¥—É–≥–∞–∞—Ä</label>
    <input type="tel" class="inp" id="phone" placeholder="9900 1234" maxlength="8"/>
    <button class="btn" id="btn">–ù—ç–≤—Ç—Ä—ç—Ö ‚Üí</button>
    <div class="err" id="err"></div>
  </div>

  <!-- –ê–ª—Ö–∞–º 2: PIN -->
  <div id="step-pin" style="display:none">
    <div style="text-align:center;margin-bottom:4px;font-size:32px">üîí</div>
    <div style="font-size:16px;font-weight:700;color:#1a2332;text-align:center;margin-bottom:4px" id="pin-title">PIN –æ—Ä—É—É–ª–Ω–∞ —É—É</div>
    <div style="font-size:13px;color:#8a96a8;text-align:center;margin-bottom:20px" id="pin-sub"></div>
    <div style="display:flex;justify-content:center;gap:14px;margin-bottom:24px">
      <div class="dot" id="pd0"></div><div class="dot" id="pd1"></div>
      <div class="dot" id="pd2"></div><div class="dot" id="pd3"></div>
    </div>
    <div class="numpad">
      <button class="np" onclick="pinInput('1')">1</button>
      <button class="np" onclick="pinInput('2')">2</button>
      <button class="np" onclick="pinInput('3')">3</button>
      <button class="np" onclick="pinInput('4')">4</button>
      <button class="np" onclick="pinInput('5')">5</button>
      <button class="np" onclick="pinInput('6')">6</button>
      <button class="np" onclick="pinInput('7')">7</button>
      <button class="np" onclick="pinInput('8')">8</button>
      <button class="np" onclick="pinInput('9')">9</button>
      <button class="np" style="background:transparent;border:none;font-size:14px;color:#6b7a8d" onclick="goBack()">‚Üê –ë—É—Ü–∞—Ö</button>
      <button class="np" onclick="pinInput('0')">0</button>
      <button class="np" style="color:#b91c1c;border-color:#fee2e2" onclick="pinDel()">‚å´</button>
    </div>
    <div class="err" id="pin-err"></div>
    <div id="warn-box" style="display:none;margin-top:12px;padding:12px 14px;border-radius:10px;background:#fff8e1;border:1.5px solid #f59e0b;color:#92400e;font-size:13px;font-weight:600;text-align:center">‚ö†Ô∏è PIN –º–∞—Ä—Ç—Å–∞–Ω –±–æ–ª –º–µ–Ω–µ–∂–µ—Ä—Ç—ç—ç —Ö–∞–Ω–¥–∞–Ω–∞ —É—É</div>
  </div>
</div>

<script>
var SB_URL='https://lgnjvltiqtnhpqdvpihq.supabase.co';
var SB_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxnbmp2bHRpcXRuaHBxZHZwaWhxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1NzE4ODMsImV4cCI6MjA4NzE0Nzg4M30.F_B1FKATIEMYfbMtEh1gRmN6jUonT9u1spG3xonMKfE';
var HDR={'apikey':SB_KEY,'Authorization':'Bearer '+SB_KEY};
var foundUser=null,userType='',pinBuf='',pinMode='',pinNew1='';

function getPK(id){
  // admin.html-—Ç–∞–π –∏–∂–∏–ª key: sl_pin_ID
  // driver.html-—Ç–∞–π –∏–∂–∏–ª key: pin_ID
  if(userType==='staff') return 'sl_pin_'+id;
  return 'pin_'+id;
}
function showErr(msg){var e=document.getElementById('err');e.textContent=msg;e.style.display=msg?'block':'none';}
function showPinErr(msg){var e=document.getElementById('pin-err');e.textContent=msg;e.style.display=msg?'block':'none';}
function updateDots(){for(var i=0;i<4;i++)document.getElementById('pd'+i).className='dot'+(i<pinBuf.length?' filled':'');}
function pinShake(){for(var i=0;i<4;i++)document.getElementById('pd'+i).className='dot error';setTimeout(function(){pinBuf='';updateDots();},700);}
function pinDel(){if(pinBuf.length>0){pinBuf=pinBuf.slice(0,-1);updateDots();}}
function pinInput(n){if(pinBuf.length>=4)return;pinBuf+=n;updateDots();if(pinBuf.length===4)setTimeout(handlePin,180);}

function showPin(mode){
  pinMode=mode;pinBuf='';pinNew1='';updateDots();
  document.getElementById('step-phone').style.display='none';
  document.getElementById('step-pin').style.display='block';
  document.getElementById('pin-err').style.display='none';
  document.getElementById('warn-box').style.display='none';
  if(mode==='new'){
    document.getElementById('pin-title').textContent='–®–∏–Ω—ç PIN “Ø“Ø—Å–≥—ç—Ö';
    document.getElementById('pin-sub').textContent='4 –æ—Ä–æ–Ω—Ç–æ–π PIN –∫–æ–¥ —Ç–æ—Ö–∏–π–Ω–æ';
  } else {
    document.getElementById('pin-title').textContent='PIN –æ—Ä—É—É–ª–Ω–∞ —É—É';
    document.getElementById('pin-sub').textContent=foundUser.name||'';
  }
}

function handlePin(){
  var stored=localStorage.getItem(getPK(foundUser.id));
  if(pinMode==='verify'){
    if(pinBuf===stored){enterApp();}
    else{showPinErr('–ë—É—Ä—É—É PIN. –î–∞—Ö–∏–Ω –æ—Ä–æ–ª–¥–æ–Ω–æ —É—É.');document.getElementById('warn-box').style.display='block';pinShake();}
  } else {
    if(pinNew1===''){
      pinNew1=pinBuf;pinBuf='';updateDots();
      document.getElementById('pin-title').textContent='PIN –¥–∞–≤—Ç–∞–Ω–∞ –æ—Ä—É—É–ª–Ω–∞ —É—É';
      document.getElementById('pin-sub').textContent='–ë–∞—Ç–∞–ª–≥–∞–∞–∂—É—É–ª–∂ –¥–∞–≤—Ç–∞–Ω–∞ –æ—Ä—É—É–ª–Ω–∞ —É—É';
    } else {
      if(pinBuf===pinNew1){
        localStorage.setItem(getPK(foundUser.id),pinBuf);
        var tbl=userType==='staff'?'staff':'drivers';
        fetch(SB_URL+'/rest/v1/'+tbl+'?id=eq.'+foundUser.id,{method:'PATCH',headers:Object.assign({},HDR,{'Content-Type':'application/json','Prefer':'return=minimal'}),body:'{"pin_reset":false}'}).catch(function(){});
        enterApp();
      } else {
        showPinErr('PIN —Ç–∞–∞—Ä–∞—Ö–≥“Ø–π. –î–∞—Ö–∏–Ω –æ—Ä–æ–ª–¥–æ–Ω–æ —É—É.');
        pinNew1='';pinShake();
        setTimeout(function(){document.getElementById('pin-title').textContent='–®–∏–Ω—ç PIN “Ø“Ø—Å–≥—ç—Ö';document.getElementById('pin-sub').textContent='4 –æ—Ä–æ–Ω—Ç–æ–π PIN –∫–æ–¥ —Ç–æ—Ö–∏–π–Ω–æ';},800);
      }
    }
  }
}

function enterApp(){
  if(userType==='staff') window.location.href='admin.html?phone='+encodeURIComponent(foundUser.phone);
  else window.location.href='driver.html?phone='+encodeURIComponent(foundUser.phone);
}

function goBack(){
  document.getElementById('step-pin').style.display='none';
  document.getElementById('step-phone').style.display='block';
  showErr('');
}

function doLogin(){
  var phone=document.getElementById('phone').value.replace(/\D/g,'').trim();
  showErr('');
  if(phone.length<8){document.getElementById('phone').classList.add('error');setTimeout(function(){document.getElementById('phone').classList.remove('error');},400);showErr('–£—Ç–∞—Å–Ω—ã –¥—É–≥–∞–∞—Ä–∞–∞ –±”©–≥–ª”©–Ω”© —É—É!');return;}
  var btn=document.getElementById('btn');
  btn.disabled=true;btn.textContent='...';
  fetch(SB_URL+'/rest/v1/staff?phone=eq.'+encodeURIComponent(phone),{headers:HDR})
  .then(function(r){return r.json();})
  .then(function(sData){
    if(Array.isArray(sData)&&sData.length>0&&!sData.message){
      btn.disabled=false;btn.textContent='–ù—ç–≤—Ç—Ä—ç—Ö ‚Üí';
      foundUser=sData[0];userType='staff';
      var stored=localStorage.getItem(getPK(foundUser.id));
      if(foundUser.pin_reset){localStorage.removeItem(getPK(foundUser.id));stored=null;}
      showPin(stored?'verify':'new');
      return;
    }
    return fetch(SB_URL+'/rest/v1/drivers?phone=eq.'+encodeURIComponent(phone),{headers:HDR})
    .then(function(r){return r.json();})
    .then(function(dData){
      btn.disabled=false;btn.textContent='–ù—ç–≤—Ç—Ä—ç—Ö ‚Üí';
      if(Array.isArray(dData)&&dData.length>0&&!dData.message){
        foundUser=dData[0];userType='driver';
        var stored=localStorage.getItem(getPK(foundUser.id));
        if(foundUser.pin_reset){localStorage.removeItem(getPK(foundUser.id));stored=null;}
        showPin(stored?'verify':'new');
      } else {
        document.getElementById('phone').classList.add('error');
        setTimeout(function(){document.getElementById('phone').classList.remove('error');},400);
        showErr('–£—Ç–∞—Å–Ω—ã –¥—É–≥–∞–∞—Ä –±“Ø—Ä—Ç–≥—ç–ª–≥“Ø–π –±–∞–π–Ω–∞. –ú–µ–Ω–µ–∂–µ—Ä—Ç—ç—ç —Ö–∞–Ω–¥–∞–Ω–∞ —É—É.');
      }
    });
  })
  .catch(function(e){btn.disabled=false;btn.textContent='–ù—ç–≤—Ç—Ä—ç—Ö ‚Üí';showErr('–•–æ–ª–±–æ–ª—Ç—ã–Ω –∞–ª–¥–∞–∞: '+e.message);});
}

document.getElementById('phone').addEventListener('input',function(){this.value=this.value.replace(/\D/g,'');});
document.getElementById('phone').addEventListener('keydown',function(e){if(e.key==='Enter')doLogin();});
document.getElementById('btn').addEventListener('click',doLogin);
</script>
</body>
</html>